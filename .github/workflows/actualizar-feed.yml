name: Actualizar noticias diarias

on:
  schedule:
    - cron: "0 7 * * *"  # 07:00 UTC = 08:00 Madrid
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  actualizar-feed:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip install feedparser requests

      - name: Generar archivo XML actualizado con noticias reales
        run: |
          mkdir -p docs

          python3 - <<'PYCODE'
import feedparser, datetime

def obtener_titulares(url, max_items=2):
    feed = feedparser.parse(url)
    noticias = []
    for entry in feed.entries[:max_items]:
        titulo = entry.title
        fuente = entry.link.split("/")[2]
        noticias.append(f"- {titulo} ({fuente})")
    return "<br>".join(noticias) if noticias else "- Sin noticias disponibles"

bloques = {
    "ğŸ‡ªğŸ‡¸ <b>Noticias en EspaÃ±a:</b>": obtener_titulares("https://feeds.elpais.com/mrss-s/pages/ep/site/elpais.com/portada"),
    "ğŸ™ï¸ <b>Noticias en Madrid:</b>": obtener_titulares("https://www.20minutos.es/rss/madrid/"),
    "ğŸŒ <b>EconomÃ­a mundial:</b>": obtener_titulares("https://feeds.reuters.com/reuters/businessNews"),
    "ğŸ’¶ <b>EconomÃ­a en EspaÃ±a:</b>": obtener_titulares("https://e00-expansion.uecdn.es/rss/economia.xml"),
    "ğŸ—ï¸ <b>Sector de la construcciÃ³n:</b>": obtener_titulares("https://www.construible.es/feed"),
    "ğŸ¢ <b>Grupo ACS / Dragados S.A.:</b>": obtener_titulares("https://e00-expansion.uecdn.es/rss/empresas.xml"),
}

fecha_hoy = datetime.date.today().strftime("%d/%m/%Y")
pubdate = datetime.datetime.now().strftime("%a, %d %b %Y %H:%M:%S +0100")

with open("docs/noticias-diarias.xml.txt", "w", encoding="utf-8") as f:
    f.write('<?xml version="1.0" encoding="UTF-8"?>\n')
    f.write('<rss version="2.0">\n  <channel>\n')
    f.write('    <title>Noticias Diarias - EspaÃ±a</title>\n')
    f.write('    <link>https://edekmm.github.io/Noticias-diarias/docs/noticias-diarias.xml.txt</link>\n')
    f.write('    <description>Noticias destacadas en EspaÃ±a, Madrid, economÃ­a mundial, economÃ­a espaÃ±ola, construcciÃ³n y Grupo ACS / Dragados.</description>\n')
    f.write('    <language>es-es</language>\n\n')
    f.write(f'    <item>\n      <title>Noticias del dÃ­a {fecha_hoy}</title>\n')
    f.write('      <description><![CDATA[\n')
    for bloque, contenido in bloques.items():
        f.write(f"{bloque}<br>{contenido}<br><br>\n")
    f.write('      ]]></description>\n')
    f.write(f'      <pubDate>{pubdate}</pubDate>\n')
    f.write('    </item>\n  </channel>\n</rss>')
PYCODE

      - name: Commit & push (si hay cambios)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/noticias-diarias.xml.txt
          git diff --staged --quiet || git commit -m "ActualizaciÃ³n automÃ¡tica del feed con noticias reales"
          git push
