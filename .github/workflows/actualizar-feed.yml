name: Actualizar noticias diarias

on:
  schedule:
    - cron: "0 7 * * *"  # 07:00 UTC = 08:00 en Madrid
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generar:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests googletrans==4.0.0-rc1

      - name: Generar feeds RSS automáticos
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        run: |
          mkdir -p docs
          FECHA=$(TZ="Europe/Madrid" date +"%d/%m/%Y")
          PUBDATE=$(TZ="Europe/Madrid" date -R)

          # Crear script Python temporal
          cat > generar_feeds.py <<'PYCODE'
import requests, os, datetime
from googletrans import Translator

translator = Translator()
API_KEY = os.getenv("NEWSAPI_KEY")

fuentes = {
    "espana": "Spain",
    "madrid": "Madrid",
    "economia_mundial": "global economy",
    "economia_espana": "Spain economy",
    "construccion": "construction sector Spain",
    "acs_dragados": "ACS construction OR Dragados company"
}

def traducir(texto):
    try:
        return translator.translate(texto, dest="es").text
    except:
        return texto

def obtener_noticias(tema):
    url = f"https://newsapi.org/v2/everything?q={tema}&language=en&sortBy=publishedAt&pageSize=3&apiKey={API_KEY}"
    r = requests.get(url)
    data = r.json()
    noticias = []
    for art in data.get("articles", []):
        titulo = traducir(art["title"])
        desc = traducir(art["description"] or "")
        link = art["url"]
        noticias.append((titulo, desc, link))
    return noticias

fecha = datetime.datetime.now().strftime("%d/%m/%Y")
pubdate = datetime.datetime.now(datetime.timezone.utc).strftime("%a, %d %b %Y %H:%M:%S %z")

for clave, tema in fuentes.items():
    noticias = obtener_noticias(tema)
    xml = f'''<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>Noticias diarias - {clave.replace("_", " ").title()}</title>
    <link>https://edekmm.github.io/Noticias-diarias/docs/{clave}.xml.txt</link>
    <description>Noticias sobre {tema} actualizadas automáticamente.</description>
    <language>es-es</language>
'''
    for t, d, l in noticias:
        xml += f'''
    <item>
      <title>{t}</title>
      <description><![CDATA[{d}]]></description>
      <link>{l}</link>
      <pubDate>{pubdate}</pubDate>
    </item>'''
    xml += "\n  </channel>\n</rss>"

    with open(f"docs/{clave}.xml.txt", "w") as f:
        f.write(xml)
PYCODE

          python generar_feeds.py

      - name: Confirmar y subir cambios
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase
          git add docs/*.xml.txt
          git commit -m "Actualización automática de feeds del día ${FECHA}" || echo "Sin cambios nuevos"
          git push
