name: Actualizar noticias diarias

on:
  schedule:
    - cron: "0 7 * * *"  # 07:00 UTC = 08:00 hora Madrid
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generar:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Actualizar pip e instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests googletrans==4.0.0-rc1

      - name: Crear script de generaci√≥n de feeds
        shell: bash
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        run: |
          mkdir -p scripts
          cat > scripts/generar_feeds.py <<'PY'
#!/usr/bin/env python3
import os, requests, datetime
from googletrans import Translator

translator = Translator()
API_KEY = os.getenv("NEWSAPI_KEY", "")

# fuentes: (query, icono)
FUENTES = {
    "espana": ("Spain", "üá™üá∏"),
    "madrid": ("Madrid", "üèôÔ∏è"),
    "economia_mundial": ("global economy", "üåç"),
    "economia_espana": ("Spain economy", "üí∂"),
    "construccion": ("construction sector Spain", "üèóÔ∏è"),
    "acs_dragados": ("ACS construction OR Dragados company", "üè¢")
}

def traducir(texto):
    try:
        if not texto:
            return ""
        return translator.translate(texto, dest="es").text
    except Exception:
        return texto or ""

def obtener_noticias(tema, page_size=3):
    # Consultamos everything para mayor cobertura; filtramos por idioma en la llamada (en ingl√©s)
    url = f"https://newsapi.org/v2/everything"
    params = {
        "q": tema,
        "language": "en",
        "sortBy": "publishedAt",
        "pageSize": page_size,
        "apiKey": API_KEY
    }
    try:
        r = requests.get(url, params=params, timeout=15)
        data = r.json()
    except Exception:
        data = {}
    noticias = []
    for art in data.get("articles", []):
        titulo_orig = art.get("title", "") or ""
        desc_orig = art.get("description", "") or ""
        link = art.get("url", "") or ""
        img = art.get("urlToImage", "") or ""
        titulo = traducir(titulo_orig)
        desc = traducir(desc_orig)
        noticias.append((titulo, desc, link, img))
    return noticias

def generar():
    docs_dir = "docs"
    os.makedirs(docs_dir, exist_ok=True)
    fecha = datetime.datetime.now().strftime("%d/%m/%Y")
    pubdate = datetime.datetime.now(datetime.timezone.utc).strftime("%a, %d %b %Y %H:%M:%S %z")

    for clave, (tema, icono) in FUENTES.items():
        noticias = obtener_noticias(tema)
        # Si no hay noticias, a√±adimos un texto de aviso
        if not noticias:
            noticias = [("Sin titulares disponibles", "No se han encontrado noticias para esta categor√≠a.", "", "")]

        xml = '<?xml version="1.0" encoding="UTF-8"?>\\n'
        xml += '<rss version="2.0">\\n  <channel>\\n'
        xml += f'    <title>Noticias diarias - {clave.replace("_", " ").title()}</title>\\n'
        xml += f'    <link>https://edekmm.github.io/Noticias-diarias/docs/{clave}.xml.txt</link>\\n'
        xml += f'    <description>Noticias sobre {tema} actualizadas autom√°ticamente.</description>\\n'
        xml += '    <language>es-es</language>\\n'

        for t, d, l, img in noticias:
            img_html = f\'<img src="{img}" width="120" style="border-radius:8px;"><br>\' if img else ""
            description = f"{icono} {img_html}<b>{t}</b><br><br>{d}<br><a href=\"{l}\">Leer m√°s</a>"
            # Escape no necesario porque traducir devuelve texto plano; usamos CDATA
            xml += "\\n    <item>\\n"
            xml += f"      <title>{t}</title>\\n"
            xml += f"      <description><![CDATA[{description}]]></description>\\n"
            xml += f"      <link>{l}</link>\\n"
            xml += f"      <pubDate>{pubdate}</pubDate>\\n"
            xml += "    </item>"

        xml += "\\n  </channel>\\n</rss>"

        with open(os.path.join(docs_dir, f"{clave}.xml.txt"), "w", encoding="utf-8") as fh:
            fh.write(xml)

if __name__ == '__main__':
    generar()
PY

      - name: Ejecutar script de generaci√≥n
        shell: bash
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        run: |
          python3 scripts/generar_feeds.py

      - name: Subir cambios (commit & push)
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add docs/*.xml.txt || true
          if git diff --cached --quiet; then
            echo "No hay cambios nuevos."
          else
            FECHA=$(TZ="Europe/Madrid" date +"%d/%m/%Y")
            git commit -m "Actualizaci√≥n autom√°tica de feeds del d√≠a ${FECHA}"
            git push origin main
          fi
