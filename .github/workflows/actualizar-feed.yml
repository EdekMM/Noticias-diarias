name: Actualizar noticias diarias

on:
  schedule:
    - cron: "0 7 * * *"  # 07:00 UTC = 08:00 Madrid
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generar:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar repositorio
        uses: actions/checkout@v4

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install requests googletrans==4.0.0-rc1

      - name: Generar feeds RSS autom√°ticos con im√°genes
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        run: |
          mkdir -p docs
          FECHA=$(TZ="Europe/Madrid" date +"%d/%m/%Y")
          PUBDATE=$(TZ="Europe/Madrid" date -R)

          cat > generar_feeds.py <<'PYCODE'
import requests, os, datetime
from googletrans import Translator

translator = Translator()
API_KEY = os.getenv("NEWSAPI_KEY")

fuentes = {
    "espana": ("Spain", "üá™üá∏"),
    "madrid": ("Madrid", "üèôÔ∏è"),
    "economia_mundial": ("global economy", "üåç"),
    "economia_espana": ("Spain economy", "üí∂"),
    "construccion": ("construction sector Spain", "üèóÔ∏è"),
    "acs_dragados": ("ACS construction OR Dragados company", "üè¢")
}

def traducir(texto):
    try:
        return translator.translate(texto, dest="es").text
    except Exception:
        return texto or ""

def obtener_noticias(tema):
    url = f"https://newsapi.org/v2/everything?q={tema}&language=en&sortBy=publishedAt&pageSize=3&apiKey={API_KEY}"
    r = requests.get(url)
    data = r.json()
    noticias = []
    for art in data.get("articles", []):
        titulo = traducir(art.get("title", ""))
        desc = traducir(art.get("description", ""))
        link = art.get("url", "")
        img = art.get("urlToImage", "")
        noticias.append((titulo, desc, link, img))
    return noticias

fecha = datetime.datetime.now().strftime("%d/%m/%Y")
pubdate = datetime.datetime.now(datetime.timezone.utc).strftime("%a, %d %b %Y %H:%M:%S %z")

for clave, (tema, icono) in fuentes.items():
    noticias = obtener_noticias(tema)
    xml = f'''<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>Noticias diarias - {clave.replace("_", " ").title()}</title>
    <link>https://edekmm.github.io/Noticias-diarias/docs/{clave}.xml.txt</link>
    <description>Noticias sobre {tema} actualizadas autom√°ticamente.</description>
    <language>es-es</language>
'''
    for t, d, l, img in noticias:
        img_html = f'<img src="{img}" width="480"/><br>' if img else ""
        xml += f'''
    <item>
      <title>{t}</title>
      <description><![CDATA[{icono} {img_html}<b>{t}</b><br><br>{d}<br><a href="{l}">Leer m√°s</a>]]></description>
      <link>{l}</link>
      <pubDate>{pubdate}</pubDate>
    </item>'''
    xml += "\n  </channel>\n</rss>"

    with open(f"docs/{clave}.xml.txt", "w") as f:
        f.write(xml)
PYCODE

          python generar_feeds.py

      - name: Subir cambios al repositorio
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase
          git add docs/*.xml.txt
          git commit -m "Actualizaci√≥n autom√°tica de feeds del d√≠a ${FECHA}" || echo "Sin cambios nuevos"
          git push
